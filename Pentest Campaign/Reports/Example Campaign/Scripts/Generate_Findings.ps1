param(
  [ValidateSet('nmap','nessus')][string]$Type,
  [Parameter(Mandatory=$true)][string]$Input,
  [string]$CampaignRoot = "..\",
  [int]$MinSeverity = 1,
  [string]$Python = '',
  [string]$ScriptPath = ''
)

Set-StrictMode -Version Latest
$ErrorActionPreference = 'Stop'

function Resolve-Python {
  param([string]$Preferred)
  if ($Preferred) { return $Preferred }
  if (Get-Command python -ErrorAction SilentlyContinue) { return 'python' }
  if (Get-Command py -ErrorAction SilentlyContinue) { return 'py' }
  throw 'Python not found; install 3.8+ or pass -Python'
}

$pythonExe = Resolve-Python -Preferred $Python
$scriptFile = $ScriptPath
if (-not $scriptFile) {
  $scriptDir = if ($PSCommandPath) { Split-Path -Parent $PSCommandPath } else { Split-Path -Parent $MyInvocation.MyCommand.Path }
  $scriptFile = Join-Path -Path $scriptDir -ChildPath 'generate_findings.py'
}
if (-not (Test-Path $scriptFile)) { throw "Missing $scriptFile" }

$argsList = @($scriptFile, '--type', $Type, '--input', (Resolve-Path $Input).Path, '--campaign', (Resolve-Path $CampaignRoot).Path)
if ($Type -eq 'nessus') { $argsList += @('--min-severity', $MinSeverity) }
if ($pythonExe -eq 'py') { $argsList = @('-3') + $argsList }
try {
  $inArg = $Input
  $campArg = $CampaignRoot
  $argsList = @($scriptFile, '--type', $Type, '--input', $inArg, '--campaign', $campArg)
  if ($Type -eq 'nessus') { $argsList += @('--min-severity', $MinSeverity) }
  if ($pythonExe -eq 'py') { $argsList = @('-3') + $argsList }
  Write-Host "Invoking: $pythonExe $($argsList -join ' ')" -ForegroundColor DarkGray
  & $pythonExe @argsList
} catch {
  throw $_
}
