<#
Run_Evidence_Finder.ps1
Automates SE Evidence Finder for campaign directories
#>

param(
    [string]$Src = "C:\\temp\\raw_evidence",
    [string]$Vault = "C:\\OffsecDEV\\OffsecDEV_Root\\Pentest Campaign",
    [string]$Campaign = "Example Campaign",
    [switch]$IncludeOther = $false,
    [int]$MaxSizeMB = 0,
    [int]$Workers = 0,
    [switch]$DryRun = $false,
    [ValidateSet('copy','move')][string]$Mode = 'copy',
    [string]$LogFile = '',
    [string]$Python = ''
)

Set-StrictMode -Version Latest
$ErrorActionPreference = 'Stop'

Write-Host "=== Starting SE Evidence Finder for $Campaign ===" -ForegroundColor Cyan

# Activate local venv if it exists
if (Test-Path ".\\.venv\\Scripts\\Activate.ps1") {
    Write-Host "Activating virtual environment..." -ForegroundColor Yellow
    . .\\.venv\\Scripts\\Activate.ps1
} else {
    Write-Host "No venv found; running system Python" -ForegroundColor Yellow
}

# Resolve Python executable
function Resolve-Python {
    param([string]$Preferred)
    if ($Preferred) { return $Preferred }
    if (Get-Command python -ErrorAction SilentlyContinue) { return 'python' }
    if (Get-Command py -ErrorAction SilentlyContinue) { return 'py' }
    throw 'Python executable not found in PATH. Install Python 3.8+ or provide -Python'
}

$pythonExe = Resolve-Python -Preferred $Python
$scriptPath = Join-Path -Path $PSScriptRoot -ChildPath 'se_evidence_finder_copy.py'

if (-not (Test-Path $scriptPath)) {
    throw "Python script not found at $scriptPath"
}

$argsList = @()
if ($pythonExe -eq 'py') { $argsList += '-3' }
$argsList += @($scriptPath, '--src', $Src, '--campaign', $Campaign, '--vault', $Vault)
if ($IncludeOther) { $argsList += '--include-other' }
if ($DryRun) { $argsList += '--dry-run' }
if ($MaxSizeMB -gt 0) { $argsList += @('--max-size-mb', $MaxSizeMB) }
if ($Workers -gt 0) { $argsList += @('--workers', $Workers) }
$argsList += @('--mode', $Mode)
if ($LogFile) { $argsList += @('--log-file', $LogFile) }

Write-Host "Invoking: $pythonExe $($argsList -join ' ')" -ForegroundColor DarkGray
& $pythonExe @argsList

# Deactivate environment if available
if (Get-Command -Name 'deactivate' -ErrorAction SilentlyContinue) {
    deactivate
}

Write-Host "=== Evidence Finder completed ===" -ForegroundColor Green
